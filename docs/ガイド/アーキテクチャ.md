# Tennis Discovery Agent - アーキテクチャ

最終更新: 2025-11-29

## システム構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                         Discord (フロントエンド)                   │
│  チャンネル: #壁打ち #スクール #試合 #フリー練習 #振り返り #質問 #分析  │
│  入力: 🎤音声 💬テキスト 🖼️画像 🎥動画                              │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Discord Bot (src/bot/)                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ client.py - メインクライアント                               │   │
│  │ channel_handler.py - チャンネル別ルーティング                  │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ handlers/                                                 │   │
│  │  ├── message_handler.py (音声・テキスト・画像・動画処理)       │   │
│  │  └── dm_handler.py (Bot停止時のDM処理)                     │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ボタンUI & 特殊チャンネル                                   │   │
│  │  ├── action_buttons.py (🔍もっと詳しく 📊比較 💾保存)        │   │
│  │  ├── question_handler.py (#質問チャンネル)                  │   │
│  │  └── analysis_handler.py (#分析チャンネル)                  │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                  AI処理レイヤー (src/ai/)                         │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ gemini_client.py - Gemini API クライアント                  │   │
│  │  • 音声文字起こし (Gemini 2.5 Flash)                        │   │
│  │  • 構造化データ抽出 (JSON mode)                             │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ structured_extraction.py - シーン別プロンプト               │   │
│  │  • 壁打ち / スクール / 試合 / フリー練習                     │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ question_generation.py - ソクラテス式問答                   │   │
│  │ auto_decision.py - AIの自動判断 (深掘り・比較・保存)          │   │
│  └──────────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────────┘
                         │
            ┌────────────┼────────────┐
            ▼            ▼            ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  検索 (search/) │ │ 分析 (analysis/)│ │ストレージ (storage/)│
├─────────────────┤ ├─────────────────┤ ├─────────────────┤
│ embedding.py    │ │ comparison.py   │ │ obsidian_mgr.py │
│  • Embedding生成│ │  • 過去との比較  │ │  • メモ検索     │
│  • バッチ処理   │ │                 │ │  • 追記機能     │
├─────────────────┤ ├─────────────────┤ ├─────────────────┤
│ vector_search.py│ │ contradiction.py│ │ github_mgr.py   │
│  • ChromaDB統合 │ │  • 矛盾検出     │ │  • 自動コミット │
│  • 意味検索     │ │                 │ │  • Push         │
├─────────────────┤ ├─────────────────┤ ├─────────────────┤
│ sensation.py    │ │ statistics.py   │ │ auto_linking.py │
│  • 感覚検索     │ │  • 統計・グラフ │ │  • リンク生成   │
│  • 類義語辞書   │ │  • トレンド分析 │ │                 │
│                 │ ├─────────────────┤ └─────────────────┘
│                 │ │ pattern.py      │
│                 │ │  • パターン分析  │
│                 │ ├─────────────────┤
│                 │ │ prediction.py   │
│                 │ │  • 成長予測     │
│                 │ │  • 練習メニュー │
│                 │ │  • コンディション│
└─────────────────┘ └─────────────────┘
         │                   │
         ▼                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                    データストレージ                                │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ChromaDB (./chroma_db/) - ベクトルDB                       │   │
│  │  • Embedding保存                                          │   │
│  │  • コサイン類似度検索                                       │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Obsidian Vault (Markdown)                                 │   │
│  │  • 練習メモ (.md)                                          │   │
│  │  • 画像・動画 (attachments/)                               │   │
│  │  • 自動リンク、バックリンク                                 │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ GitHub (バージョン管理 + Git LFS)                           │   │
│  │  • Markdownの履歴管理                                      │   │
│  │  • 画像・動画はGit LFS                                     │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## データフロー

### 1. 音声メモの処理フロー

```
📱 Discord音声送信
   ↓
🤖 Discord Bot受信 (message_handler.py)
   ↓
🎤 Gemini API: 音声 → テキスト (gemini_client.py)
   ↓
🧠 Gemini API: テキスト → 構造化データ (structured_extraction.py)
   ↓
📝 Markdownファイル生成 (markdown_helpers.py)
   ├─→ 📊 前回ログ読み込み (previous_log.py)
   ├─→ 🔗 自動リンク生成 (auto_linking.py)
   └─→ 📈 統計更新 (statistics.py)
   ↓
💾 Obsidian Vault保存 (obsidian_manager.py)
   ↓
🔄 GitHub自動Push (github_manager.py)
   ↓
🎯 Embedding生成 (embedding.py)
   ↓
🗄️ ChromaDBに保存 (vector_search.py)
   ↓
✅ Discord応答表示 (🔄サイクル、ボタンUI)
```

### 2. 意味検索のフロー

```
💬 検索クエリ入力 (#質問チャンネル)
   ↓
🎯 クエリEmbedding生成 (embedding.py)
   ↓
🔍 ChromaDBで類似検索 (vector_search.py)
   ↓
📄 関連メモ取得 (上位5件)
   ↓
🧠 Gemini: 要約・回答生成 (question_handler.py)
   ↓
✅ Discord応答表示
```

### 3. AI分析のフロー

```
💬 「今月の分析」とメッセージ (#分析チャンネル)
   ↓
📅 期間検出 (analysis_handler.py)
   ↓
📚 該当期間のメモ収集 (obsidian_manager.py)
   ↓
🧠 Gemini: パターン分析 (pattern_analysis.py)
   ├─→ 好調/不調パターン
   ├─→ 時系列トレンド
   ├─→ ターニングポイント
   └─→ 成長予測 (prediction.py)
   ↓
📊 分析レポート生成 (Markdown)
   ↓
✅ Discord応答表示
```

---

## モジュール間の依存関係

```
┌─────────────────┐
│   Discord Bot   │ (最上位レイヤー)
└────────┬────────┘
         │ 依存
    ┌────┴────┐
    ▼         ▼
┌─────┐   ┌─────┐
│ AI  │   │検索 │
└──┬──┘   └──┬──┘
   │依存     │依存
   ▼         ▼
┌──────────────┐
│ ストレージ    │ (最下位レイヤー)
└──────────────┘
```

### 依存関係の詳細

| 依存元 | 依存先 | 理由 |
|--------|--------|------|
| `bot/*` | `ai/*` | AI処理を呼び出し |
| `bot/*` | `search/*` | 検索機能を呼び出し |
| `bot/*` | `analysis/*` | 分析機能を呼び出し |
| `bot/*` | `storage/*` | データ保存・取得 |
| `search/embedding.py` | `ai/gemini_client.py` | Gemini Embedding API |
| `search/vector_search.py` | `search/embedding.py` | Embedding生成 |
| `analysis/*` | `storage/obsidian_manager.py` | メモ取得 |
| `analysis/*` | `ai/gemini_client.py` | AI分析 |

**循環依存なし** - クリーンなアーキテクチャを維持

---

## Phase別の実装レイヤー

| Phase | 主な実装箇所 |
|-------|------------|
| **Phase 1** | `src/bot/handlers/`, `src/storage/`, `src/ai/` |
| **Phase 2** | `src/bot/action_buttons.py`, `src/ai/question_generation.py`, `src/analysis/comparison.py` |
| **Phase 3** | `src/search/sensation_search.py`, `src/storage/auto_linking.py`, `src/analysis/statistics.py` |
| **Phase 4** | `src/search/embedding.py`, `src/search/vector_search.py`, `src/analysis/pattern_analysis.py`, `src/analysis/prediction.py` |

---

## 外部サービス連携

```
┌──────────────────┐
│ Tennis Discovery │
│      Agent       │
└────────┬─────────┘
         │
    ┌────┼────┐
    ▼    ▼    ▼
┌────┐┌────┐┌────┐
│Discord││Gemini││GitHub│
│ API││ API││ API│
└────┘└────┘└────┘
```

| サービス | 用途 | API |
|---------|------|-----|
| **Discord** | フロントエンド、音声入力 | discord.py |
| **Gemini** | 文字起こし、構造化抽出、Embedding | google-generativeai |
| **GitHub** | バージョン管理、Git LFS | PyGithub |

---

## スケーラビリティ

### 現在のキャパシティ

- **メモ数**: 10,000件以上対応
- **検索速度**: ChromaDBで数十ms（個人利用なら十分）
- **コスト**: 月100メモで約11円

### 拡張時の検討事項

| 項目 | 現状 | スケールアップ時 |
|------|------|----------------|
| ベクトルDB | ChromaDB (ローカル) | Qdrant, Weaviate (クラウド) |
| ストレージ | ローカルファイル | S3, Cloud Storage |
| インフラ | Raspberry Pi | クラウド (GCP, AWS) |
| DB | Markdownファイル | PostgreSQL, MongoDB |

---

## セキュリティ層

```
┌─────────────────────────────────┐
│        環境変数 (.env)            │
│  • DISCORD_BOT_TOKEN             │
│  • GEMINI_API_KEY                │
│  • GITHUB_TOKEN                  │
└─────────────────────────────────┘
         │ .gitignoreで除外
         ▼
┌─────────────────────────────────┐
│      アプリケーション層           │
│  • APIキーは環境変数から読み込み  │
│  • ハードコードなし               │
└─────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│      プライベートリポジトリ        │
│  • 練習内容は個人情報             │
│  • GitHubプライベートリポジトリ    │
└─────────────────────────────────┘
```

---

## パフォーマンス最適化

### 実装済みの最適化

1. **バッチ処理**: 複数のEmbedding生成を一括処理
2. **遅延ロード**: 必要な時だけモジュールをインポート
3. **キャッシング**: ObsidianManagerでメモをメモリキャッシュ
4. **非同期処理**: Discord Bot は async/await パターン

### 今後の最適化候補

1. **Embeddingキャッシュ**: 既存メモのEmbeddingを再利用
2. **インクリメンタル更新**: 変更されたメモのみ再処理
3. **並列処理**: 複数のAI処理を並列実行

---

## 開発環境 vs 本番環境

| 項目 | 開発環境 | 本番環境 |
|------|---------|---------|
| OS | macOS / Windows | Raspberry Pi OS |
| Python | 3.11+ | 3.11+ |
| データ保存先 | `./obsidian_vault` | `/home/user/obsidian-vault` |
| ログレベル | DEBUG | INFO |
| サービス管理 | 手動起動 | systemd |

---

## 参考ドキュメント

- **機能一覧**: `docs/FEATURES.md`
- **実装計画**: `docs/plan.md`
- **セットアップガイド**: `SETUP.md`
