# 実装進捗 - 引き継ぎデータ

**作成日**: 2025-12-08
**セッション**: compassionate-babbage
**実装タスク**: まとめページ機能 + Discord返信による追記機能

---

## 📋 実装済み機能

### ✅ Phase 1: Discord返信による追記機能（部分完了）

#### 1. AI解析・整形機能 ✅
**ファイル**: `src/ai/deepening_analysis.py`（新規作成）

**実装内容**:
- `analyze_and_format_reply()`: 返信内容を解析
  - 深堀り情報かどうかを判定
  - pattern（contrast/change/reason/detail）を自動判定
  - Markdown形式で整形
- `format_deepening_markdown()`: Markdown整形ヘルパー

**動作**:
- Gemini APIで返信を解析
- JSON形式で結果を返す
- 「了解」「ありがとう」などは深堀り情報でないと判定

---

#### 2. 返信ハンドラー ✅
**ファイル**: `src/bot/handlers/reply_handler.py`（新規作成）

**実装内容**:
- `handle_reply_to_memo()`: 返信メッセージ処理
  - 返信先のMessageIDを取得
  - MessageIDからメモファイルを検索
  - AI解析を実行
  - メモに追記
  - GitHub push
  - ユーザーに確認メッセージ

**動作**:
- 深堀り情報 → ✅ リアクション + 追記
- 深堀り情報でない → 👍 リアクションのみ

---

#### 3. ObsidianManager検索機能 ✅
**ファイル**: `src/storage/obsidian_manager.py`（更新）

**追加メソッド**:
- `find_memo_by_discord_id(message_id: int) -> Optional[str]`
  - Discord MessageIDからメモファイルを検索
  - YAML frontmatterの`discord_message_id`フィールドを照合
  - 見つかったらファイルパスを返す

**実装箇所**: 479行目以降に追加

---

#### 4. client.py更新 ✅
**ファイル**: `src/bot/client.py`（更新）

**変更内容**:
1. インポート追加:
```python
from src.bot.handlers.reply_handler import handle_reply_to_memo
```

2. `on_message()`に返信検知を追加（82-85行目）:
```python
# Check if this is a reply to another message
if message.reference:
    await handle_reply_to_memo(self, message)
    return
```

**動作**:
- 返信メッセージを優先的に処理
- 通常メッセージより前に判定

---

### ⚠️ Phase 1: 未完了部分

#### 5. MessageID記録機能 ❌
**必要な作業**:

**ファイル1**: `src/storage/markdown_templates.py` または `src/bot/helpers/markdown_helpers.py`
- YAML frontmatterに`discord_message_id`と`discord_channel_id`を追加

**ファイル2**: `src/bot/handlers/message_handler.py`
- メモ投稿後、送信したDiscordメッセージのIDをメモファイルに記録

**実装方針**:
```python
# message_handler.pyの各process関数内

# Discord投稿後（send_session_embed後）
sent_message = await thinking_msg.edit(...)  # または await message.channel.send(...)

# メモファイルのfrontmatterを更新
update_memo_metadata(memo_path, {
    'discord_message_id': sent_message.id,
    'discord_channel_id': message.channel.id
})

# GitHub再push
bot.github_sync.push_to_github()
```

**必要な関数**: `update_memo_metadata()` を新規作成（ObsidianManagerまたはヘルパー）

---

## 🚧 Phase 2: まとめページ生成機能（未着手）

### 実装予定ファイル

#### 1. データ収集モジュール
**ファイル**: `src/storage/summary_generator.py`（新規作成）

**実装内容**:
- `SummaryGenerator`クラス
- `collect_memos_for_summary()`: メモデータ収集
- `_extract_memo_data()`: メモファイルからデータ抽出
- `_parse_frontmatter()`: YAML解析
- `_parse_markdown_sections()`: Markdown本文解析
- `_analyze_trends()`: トレンド分析
- `generate_all_summaries()`: 6種類のまとめページ生成
- `generate_summary_overview()`: 総合まとめ生成
- `generate_summary_period()`: 期間別まとめ生成
- `generate_summary_technique()`: 技術別まとめ生成

**参考**: `docs/改修/実装仕様_まとめページ生成（AI完全生成方式）.md`

---

#### 2. AI生成用プロンプト
**ファイル**: `src/ai/summary_prompts.py`（新規作成）

**実装内容**:
- `SummaryPrompts`クラス
- `generate_overview_prompt()`: 総合まとめ用プロンプト
- `generate_technique_prompt()`: 技術別まとめ用プロンプト
- `generate_period_prompt()`: 期間別まとめ用プロンプト
- ヘルパー関数（`_format_reflections()`, `_format_insights()`等）

**プロンプト設計**:
- データをJSON形式で渡す
- Markdown形式で出力を指示
- 自然な日本語、具体的なアドバイスを生成

---

#### 3. スケジューラー統合
**ファイル**: `src/scheduler/scheduler_manager.py`（更新）

**追加内容**:
- `check_and_generate_summaries()`: まとめページ更新チェック
  - 前日にメモが追加されたかチェック
  - 追加されていれば6種類のまとめページを生成
  - GitHub push

**スケジュール**: 毎日深夜3時に実行

---

## 📂 作成済みドキュメント

### 1. ヒアリング結果
**ファイル**: `docs/改修/ヒアリング結果_まとめページ機能.md`

**内容**:
- 根本課題
- 達成したい成果
- 機能スコープ（Must Have / Nice to Have / Out of Scope）
- まとめ_総合.mdの構成例
- 技術要件
- ビジョン（短期・中期・長期）

---

### 2. Discord返信による追記機能の実装仕様
**ファイル**: `docs/改修/実装仕様_Discord返信による追記機能.md`

**内容**:
- 動作フロー
- Discord表示イメージ
- 技術実装（コード例）
- テストシナリオ
- 実装順序（Phase 1-4）

---

### 3. まとめページ生成の実装仕様
**ファイル**: `docs/改修/実装仕様_まとめページ生成（AI完全生成方式）.md`

**内容**:
- 採用方式（AI完全生成）
- 生成するファイル（6種類）
- データ収集モジュールの詳細実装
- AI生成用プロンプトの詳細実装
- スケジューラー統合
- コスト試算（月額0.29円）
- テストシナリオ

---

## 🔧 次のセッションでの作業手順

### Step 1: MessageID記録機能の完成

1. **`src/storage/obsidian_manager.py`に追加**:
```python
def update_memo_frontmatter(self, file_path: str, metadata: dict) -> bool:
    """
    Update YAML frontmatter of a memo file.

    Args:
        file_path: Path to memo file
        metadata: Metadata to add/update

    Returns:
        True if successful, False otherwise
    """
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()

        # Parse existing frontmatter
        if content.startswith('---'):
            parts = content.split('---', 2)
            if len(parts) >= 3:
                frontmatter = yaml.safe_load(parts[1])
                body = parts[2]
            else:
                frontmatter = {}
                body = content
        else:
            frontmatter = {}
            body = content

        # Update metadata
        frontmatter.update(metadata)

        # Rebuild file
        new_frontmatter = yaml.dump(frontmatter, allow_unicode=True, sort_keys=False)
        new_content = f"---\n{new_frontmatter}---{body}"

        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(new_content)

        return True

    except Exception as e:
        print(f"Error updating frontmatter: {e}")
        return False
```

2. **`src/bot/handlers/message_handler.py`の各process関数を更新**:

**process_voice_message()** (105行目付近):
```python
# Send result embed
sent_message = await send_session_embed(
    thinking_msg=thinking_msg,
    session=session,
    scene_info=scene_info,
    file_url=file_url,
    bot=bot,
)

# Record Discord message ID to memo
memo_filename = bot.markdown_builder.get_filename_for_session(session, scene_info.name)
memo_path = bot.obsidian_manager.vault_path / memo_filename
bot.obsidian_manager.update_memo_frontmatter(str(memo_path), {
    'discord_message_id': sent_message.id,
    'discord_channel_id': message.channel.id
})

# Re-push to GitHub
bot.github_sync.push_to_github()
```

**同様の変更を以下の関数にも適用**:
- `process_text_message()` (183行目付近)
- `process_image_message()` (278行目付近)
- `process_video_message()` (373行目付近)

---

### Step 2: まとめページ生成機能の実装

#### 2-1. データ収集モジュール
**作成**: `src/storage/summary_generator.py`
**参考**: `docs/改修/実装仕様_まとめページ生成（AI完全生成方式）.md` の該当セクション

**実装順序**:
1. `SummaryGenerator.__init__()`
2. `collect_memos_for_summary()`
3. `_extract_memo_data()`
4. `_parse_frontmatter()`, `_parse_markdown_sections()`
5. `_analyze_trends()`

#### 2-2. AI生成用プロンプト
**作成**: `src/ai/summary_prompts.py`
**参考**: `docs/改修/実装仕様_まとめページ生成（AI完全生成方式）.md` の該当セクション

**実装順序**:
1. `SummaryPrompts`クラス定義
2. `generate_overview_prompt()`
3. `generate_technique_prompt()`
4. `generate_period_prompt()`
5. ヘルパー関数

#### 2-3. 生成実行
**`summary_generator.py`に追加**:
1. `generate_all_summaries()`
2. `generate_summary_overview()`
3. `generate_summary_period()`
4. `generate_summary_technique()`

#### 2-4. スケジューラー統合
**更新**: `src/scheduler/scheduler_manager.py`
**追加箇所**: `start()`メソッド内

```python
# まとめページ更新チェック（毎日深夜3時）
self.scheduler.add_job(
    self.check_and_generate_summaries,
    trigger='cron',
    hour=3,
    minute=0,
    id='summary_generation'
)
```

**追加メソッド**:
```python
async def check_and_generate_summaries(self):
    """まとめページ更新チェック"""
    from datetime import datetime, timedelta
    from src.storage.summary_generator import SummaryGenerator

    # 前日にメモが追加されたかチェック
    yesterday = datetime.now() - timedelta(days=1)
    yesterday_str = yesterday.strftime('%Y-%m-%d')

    memos = self.bot.obsidian_manager.search_by_date(yesterday, scene_name=None)

    if len(memos) > 0:
        print(f"前日（{yesterday_str}）にメモが{len(memos)}件追加されました。まとめページを更新します。")

        summary_generator = SummaryGenerator(
            self.bot.obsidian_manager,
            self.bot.gemini_client,
            self.bot.github_sync
        )

        await summary_generator.generate_all_summaries()
    else:
        print(f"前日（{yesterday_str}）にメモの追加なし。まとめページ更新をスキップ。")
```

---

### Step 3: テスト・動作確認

1. **Discord返信機能のテスト**:
   - メモを投稿
   - 返信で深堀り情報を追加
   - メモファイルに追記されることを確認
   - GitHub pushされることを確認

2. **まとめページ生成のテスト**:
   - メモを数件追加
   - スケジューラーを手動実行（または翌日まで待機）
   - 6種類のまとめページが生成されることを確認
   - 内容が適切かレビュー

3. **統合テスト**:
   - 一連の流れ（メモ投稿 → 返信追記 → まとめ生成）を確認

---

## 📊 現在のファイル状態

### 変更済み（コミット前）
```
modified:   src/bot/client.py
modified:   src/storage/obsidian_manager.py
```

### 新規作成（コミット前）
```
docs/改修/
├── ヒアリング結果_まとめページ機能.md
├── 実装仕様_Discord返信による追記機能.md
├── 実装仕様_まとめページ生成（AI完全生成方式）.md
└── 実装進捗_引き継ぎ.md（このファイル）

src/ai/deepening_analysis.py
src/bot/handlers/reply_handler.py
```

---

## 🎯 優先順位

### 🔴 高優先度（必須）
1. MessageID記録機能の完成
2. まとめ_総合.mdの生成機能

### 🟡 中優先度
3. 技術別まとめ（フォアハンド、バックハンド、サーブ）
4. 期間別まとめ（最近、1ヶ月）

### 🟢 低優先度
5. スケジューラー統合
6. 包括的なテスト

---

## 💡 実装のヒント

### MessageID記録の注意点
- `send_session_embed()`は`thinking_msg`を編集するため、戻り値は`thinking_msg`
- `thinking_msg.id`でMessageIDが取得可能
- frontmatter更新後は必ずGitHub再push

### まとめページ生成の注意点
- Gemini APIの呼び出しは非同期（`await`必須）
- JSON解析時にコードブロック（```json）を除去
- 生成されたMarkdownは`.strip()`で前後の空白を削除

### デバッグのヒント
- `bot.debug = True`で詳細ログ出力
- Gemini APIのレスポンスをprintして確認
- メモファイルのYAML frontmatterが正しく更新されているか確認

---

## 📝 次回セッション開始時のコマンド

```bash
# 現在のブランチを確認
git status

# 変更をコミット（実装が完了してから）
git add .
git commit -m "feat: Discord返信による追記機能とまとめページ生成機能の実装"

# 実装を開始（まずは引き継ぎドキュメントを読む）
cat docs/改修/実装進捗_引き継ぎ.md

# MessageID記録機能から実装
# → Step 1の手順に従う
```

---

**最終更新**: 2025-12-08
**次回セッション**: MessageID記録機能の完成から開始
